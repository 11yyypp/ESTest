<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>喜好金融商品管理</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    input, select { padding: 5px; margin: 5px; }
    button { margin: 2px; padding: 5px 10px; }
    .inline { display: inline-block; margin-right: 10px; }
  </style>
</head>
<body>

<div id="app">
  <h1>喜好金融商品管理</h1>

  <!-- 新增表單 -->
  <h2>新增喜好商品</h2>
  <div>
    <input class="inline" v-model="newLike.userId" placeholder="使用者 ID">

    <!-- 產品下拉選單 -->
    <select class="inline" v-model.number="newLike.productId" @change="updateProductInfo">
      <option disabled value="">請選擇產品</option>
      <option v-for="product in products" :key="product.productId" :value="product.productId">
        {{ product.productName }}
      </option>
    </select>

	<input class="inline" v-model.number="newLike.quantity" type="number" min="1" placeholder="購買數量" @input="calculateAmount">
	<input class="inline" v-model="newLike.debitAccount" type="text" maxlength="14"placeholder="扣款帳號" @input="newLike.debitAccount = newLike.debitAccount.replace(/\D/g,'')">


    <!-- 顯示選中產品價格與手續費 -->
    <div class="inline" v-if="selectedProduct">
      價格: {{ selectedProduct.price }} | 手續費率: {{ selectedProduct.feeRate }}
    </div>
    <div class="inline" v-if="totalFee !== null">
      總手續費: {{ totalFee }} | 總金額: {{ totalAmount }}
    </div>

    <button class="inline" @click="addLike">新增</button>
  </div>

  <!-- 喜好清單 -->
  <h2>喜好清單</h2>
  <table>
  <thead>
    <tr>
      <th>SN</th>
      <th>使用者</th>
      <th>產品</th>
      <th>總金額</th>
      <th>總手續費</th>
      <th>扣款帳號</th>
      <th>聯絡信箱</th>
      <th>操作</th>
    </tr>
  </thead>
  <tbody>
    <tr v-for="like in likes" :key="like.sn">
      <td>{{ like.sn }}</td>
      <td>{{ like.userId }}</td>
      <td>{{ like.productName }}</td>
      <td>{{ like.totalAmount }}</td>
      <td>{{ like.totalFee }}</td>
      <td>{{ like.debitAccount }}</td>
      <td>{{ like.email }}</td>
      <td>
        <button @click="updateLike(like)">修改</button>
        <button @click="deleteLike(like.sn)">刪除</button>
      </td>
    </tr>
  </tbody>
</table>

</div>

<script>
const { createApp } = Vue;

createApp({
  data() {
    return {
      likes: [], // 喜好清單
      products: [], // 產品清單
      newLike: { userId: '', productId: '', quantity: 1, debitAccount: '' },
      selectedProduct: null,
      totalFee: null,
      totalAmount: null
    }
  },
  mounted() {
    this.fetchProducts();
    this.fetchLikes();
  },
  methods: {
    // 取得產品名稱
    getProductName(productId) {
      const product = this.products.find(p => p.productId === productId);
      return product ? product.productName : '';
    },

    // 取得產品清單
    async fetchProducts() {
      try {
        const res = await fetch('/product/getAll');
        if (!res.ok) throw new Error(res.statusText);
        this.products = await res.json();
      } catch (err) {
        console.error(err);
        alert('取得產品清單失敗');
     }
   },

    // 取得喜好清單
    async fetchLikes() {
      try {
        const res = await fetch('/like/getAll');
        if (!res.ok) throw new Error(res.statusText);
        this.likes = await res.json();
      } catch (err) {
        console.error(err);
        alert('取得喜好清單失敗');
     }
   },

    // 選擇產品時更新價格
    updateProductInfo() {
      this.selectedProduct = this.products.find(p => p.productId === this.newLike.productId);
      this.calculateAmount();
    },

    // 計算手續費和總金額
    calculateAmount() {
      if (!this.selectedProduct || !this.newLike.quantity) {
        this.totalFee = null;
        this.totalAmount = null;
        return;
      }
      this.totalFee = (this.selectedProduct.price * this.newLike.quantity * this.selectedProduct.feeRate).toFixed(2);
      this.totalAmount = (this.selectedProduct.price * this.newLike.quantity + parseFloat(this.totalFee)).toFixed(2);
    },

    // 新增喜好商品
    async addLike() {
 	 try {
	   const res = await fetch('/like/add', {
	   method: 'POST',
	   headers: { 'Content-Type': 'application/json' },
	   body: JSON.stringify(this.newLike)
	});
	   if (!res.ok) {
		      const errMsg = await res.text();
		      alert(errMsg); // 顯示自訂錯誤訊息
		      return;
		    }
	   const added = await res.json();
	    this.likes.push(added);  // 即時更新
	    alert('新增成功');

    // 重置表單
    this.newLike = { userId: '', productId: '', quantity: 1, debitAccount: '' };
    this.selectedProduct = null;
    this.totalFee = null;
    this.totalAmount = null;

  } catch (err) {
    console.error(err);
    alert('新增失敗: ' + err.message);
  }
},

    // 修改喜好商品
    async updateLike(like) {
      try {
        const res = await fetch(`/like/update/${like.sn}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId: like.userId,
            productId: like.productId,
            quantity: like.quantity,
            debitAccount: like.debitAccount
          })
        });
        if (!res.ok) throw new Error(await res.text());
        const updated = await res.json();

        const index = this.likes.findIndex(l => l.sn === updated.sn);
        if (index !== -1) this.likes.splice(index, 1, updated);

      } catch (err) {
        console.error(err);
        alert('修改失敗: ' + err.message);
      }
    },

    // 刪除喜好商品
    async deleteLike(sn) {
    	  const like = this.likes.find(l => l.sn === sn);
    	  if (!like) return;

    	  const confirmMsg = `確定刪除此商品？\n產品名稱：${like.productName}\n產品價格：${like.totalAmount - like.totalFee}\n手續費率：${like.totalFee / (like.totalAmount - like.totalFee)}`
    	  
    	  if (!confirm(confirmMsg)) return;

    	  try {
    	    const res = await fetch(`/like/delete/${sn}`, { method: 'DELETE' });
    	    if (!res.ok) throw new Error(await res.text());
    	    this.likes = this.likes.filter(l => l.sn !== sn);
    	    alert('刪除成功');
    	  } catch (err) {
    	    console.error(err);
    	    alert('刪除失敗: ' + err.message);
    	  }
    	}

  }
}).mount('#app');
</script>


</body>
</html>
